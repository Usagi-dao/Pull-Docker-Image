name: Pull Docker Image with Manual Input

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Dockeré•œåƒåç§° (ä¾‹å¦‚: nginx:latest æˆ– ubuntu:20.04)'
        required: true
        default: 'nginx:latest'
        type: string
      save_as_tar:
        description: 'æ˜¯å¦å°†é•œåƒä¿å­˜ä¸ºtaræ–‡ä»¶?'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  pull-docker-image:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate image name
      id: validate
      run: |
        if [[ "${{ github.event.inputs.image_name }}" =~ ^[a-zA-Z0-9][a-zA-Z0-9_.-]*(/[a-zA-Z0-9_.-]+)*(:[a-zA-Z0-9_.-]+)?$ ]]; then
          echo "âœ… é•œåƒåç§°æ ¼å¼æ­£ç¡®: ${{ github.event.inputs.image_name }}"
          echo "valid=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ é•œåƒåç§°æ ¼å¼ä¸æ­£ç¡®: ${{ github.event.inputs.image_name }}"
          echo "valid=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Pull Docker image
      run: |
        echo "å¼€å§‹æ‹‰å–é•œåƒ: ${{ github.event.inputs.image_name }}"
        docker pull ${{ github.event.inputs.image_name }}
        echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ!"

    - name: Inspect pulled image
      run: |
        echo "é•œåƒè¯¦ç»†ä¿¡æ¯:"
        docker image inspect ${{ github.event.inputs.image_name }} --format "ğŸ–¼ï¸  é•œåƒ: {{.RepoTags}}\nğŸ“ å¤§å°: {{.Size}} å­—èŠ‚\nğŸ“… åˆ›å»ºæ—¶é—´: {{.Created}}"

    - name: Save image as tar file
      if: github.event.inputs.save_as_tar == 'true'
      run: |
        # æ¸…ç†é•œåƒåç§°ä»¥åˆ›å»ºå®‰å…¨çš„æ–‡ä»¶å
        CLEAN_NAME=$(echo "${{ github.event.inputs.image_name }}" | sed 's/[^a-zA-Z0-9._-]/_/g')
        docker save -o $CLEAN_NAME.tar ${{ github.event.inputs.image_name }}
        echo "ğŸ“¦ é•œåƒå·²ä¿å­˜ä¸º: $CLEAN_NAME.tar"
        echo "ğŸ“ æ–‡ä»¶å¤§å°: $(du -h $CLEAN_NAME.tar | cut -f1)"

    - name: Upload image artifact
      if: github.event.inputs.save_as_tar == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: docker-image-${{ github.event.inputs.image_name }}
        path: "*.tar"
        retention-days: 7

    - name: Show success message
      run: |
        echo "ğŸ‰ Dockeré•œåƒæ‹‰å–å®Œæˆ!"
        echo "ğŸ“¥ æ‹‰å–çš„é•œåƒ: ${{ github.event.inputs.image_name }}"
        if [[ "${{ github.event.inputs.save_as_tar }}" == 'true' ]]; then
          echo "ğŸ“¦ é•œåƒå·²ä¿å­˜ä¸ºtaræ–‡ä»¶ï¼Œå¯åœ¨Artifactsä¸­ä¸‹è½½"
        else
          echo "ğŸ’¡ é•œåƒä»…åœ¨æœ¬æ¬¡å·¥ä½œæµè¿è¡ŒæœŸé—´å¯ç”¨"
        fi
